##-----------------------------------------------------------------------------
## plot a taxonomy tree for srdb with the width of the lines proportional
## to the number of assessments
## DR, CM
## date: Fri Dec  4 15:47:22 AST 2009
## Time-stamp: <Last modified: 3 DECEMBER 2009  (mintoc)>
##-----------------------------------------------------------------------------

require(RODBC); require(ape); require(gsubfn)
## open a channel to the database
mychan<-odbcConnect(dsn="srdbusercalo") # note how the DSN is used here

##taxo.qu<-paste("select * from srdb.taxonomy as aa, (select tsn from srdb.stock where stockid in (select stockid from srdb.assessment where assessid not like '%MYERS%')) as bb where aa.tsn=bb.tsn;")
taxo.qu<-paste("select * from srdb.taxonomy as aa, (select tsn from srdb.stock where stockid in (select stockid from srdb.assessment where assessid not like '%MYERS%')) as bb where aa.tsn=bb.tsn;")

taxo.dat<-sqlQuery(mychan, taxo.qu)
taxo.dat<-taxo.dat[order(taxo.dat$scientificname),]
taxo.dat[length(taxo.dat[,1]),]<-NA

levels(taxo.dat[length(taxo.dat[,1]),"kingdom"])<-as.factor(c("Animalia","1"))
taxo.dat[length(taxo.dat[,1]),"kingdom"]<-"1"
## to run the phylogram with edge widths proportional to the number of assessments
## we need to hiack the newick formulation for edge length
## and then pass this as an argument to the plot, e.g.

## regular tree
taxo.phylo<-as.phylo(~phylum/classname/ordername/family/genus/scientificname, data=taxo.dat)
## take a look at the contents using taxo.phylo[]
## edge width/length inclusion
taxo.2.phylo<-my.as.phylo.formula(~phylum/classname/ordername/family/genus/scientificname, data=taxo.dat)
##taxo.phylo$root.edge<-taxo.2.phylo$root.edge

## logarithm for plotting
taxo.2.phylo$log.edge.length<-sqrt(taxo.2.phylo$edge.length+0.1)
##taxo.2.phylo$log.edge.length<-log(taxo.2.phylo$edge.length+0.1)

##

prelim.tip.labels<-rep("", length(taxo.phylo$tip.label))

for(i in 2:length(prelim.tip.labels)){
  print(i)
  if(taxo.phylo$tip.label[i]!=taxo.phylo$tip.label[i-1]){
    prelim.tip.labels[i]<-taxo.phylo$tip.label[i]
  }
}

taxo.phylo$tip.label<-prelim.tip.labels

pdf("./taxonomic_coverage.pdf", width=10, height=10)
##par(mfrow=c(2,2), mar=c(0,0,0,0))
plot(taxo.phylo, type="p", edge.width=taxo.2.phylo$log.edge.length, cex=0.5, root.edge=TRUE)
plot(taxo.phylo, type="c", edge.width=taxo.2.phylo$log.edge.length, cex=0.5, root.edge=TRUE)
plot(taxo.phylo, type="r", edge.width=taxo.2.phylo$log.edge.length, cex=0.5, root.edge=TRUE)
##taxo.2.phylo$log.edge.length[2]<-0
plot(taxo.phylo, "u", cex = 0.5, edge.width=taxo.2.phylo$log.edge.length, edge.col=grey(0.5), root.edge=TRUE)
dev.off()

system("xpdf ./taxonomic_coverage.pdf")

##--------------
## SANDBOX
##--------------
##test.dat<-taxo.dat[taxo.dat$phylum=="Mollusca" | taxo.dat$phylum=="Arthropoda",c("phylum","classname","ordername", "family", "genus")]
test.dat<-taxo.dat[taxo.dat$phylum=="Chordata",c("phylum","classname","ordername", "family", "genus")]
test.dat<-test.dat[order(test.dat$genus),]

##test.phylo<-as.phylo.formula(~phylum/classname/ordername/family/genus, data=test.dat)
test.phylo<-as.phylo.formula(~classname/ordername/family/genus, data=test.dat)
test2.phylo<-my.as.phylo.formula(~phylum/classname/ordername/family/genus, data=test.dat)
plot(test.phylo, edge.width=test2.phylo$edge.length, type="p")


test.df<-data.frame(phylum.n=NA, class.n=NA, order.n=NA, family.n=NA, genus.n=NA, genus=as.character(taxo.phylo$tip.label))

for(i in 1:length(test.df[,1])){
  print(i)
  my.genus<-as.character(test.df$genus[i])
  my.family<-unique(test.dat$family[test.dat$genus==my.genus])
  my.order<-unique(test.dat$ordername[test.dat$genus==my.genus])
  my.class<-unique(test.dat$classname[test.dat$genus==my.genus])
  my.phylum<-unique(test.dat$phylum[test.dat$genus==my.genus])
  test.df [i,"genus.n"]<-length(test.dat$genus[test.dat$genus==my.genus])
  test.df [i,"family.n"]<-length(test.dat$family[test.dat$family==my.family])
  test.df [i,"order.n"]<-length(test.dat$ordername[test.dat$ordername==my.order])
  test.df [i,"class.n"]<-length(test.dat$classname[test.dat$classname==my.class])
  test.df [i,"phylum.n"]<-length(test.dat$phylum[test.dat$phylum==my.phylum])
}

## "((1,(2,3),6,(8,9,11),(10,13,14),12,15,17),((4,5),7,16));"

test.new<-read.tree(text="(B:6.0,(A:5.0,C:3.0,E:4.0):5.0,D:11.0);")

edge.length.vec<-rep(1,dim(test.phylo$edge)[1])
edge.length.vec[c(2,3)]<-test.df[1,1]

plot(test.phylo, type="c", cex=1, edge.width=edge.length.vec)


lines(c(0, taxo.phylo$edge[2,1]),c(75, taxo.phylo$edge[2,2]), col="red")

data(carnivora)
plot(as.phylo(~SuperFamily/Family/Genus/Species, data=carnivora))

plot(bird.orders, edge.width = sample(1:10, length(bird.orders$edge)/2, replace = TRUE))


odbcClose(mychan)

