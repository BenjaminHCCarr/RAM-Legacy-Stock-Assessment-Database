##------------------------------------------------------------------------------
## Estimate multispecies trends in un-scaled SSB
## CM
## date: Tue Feb 23 20:01:37 AST 2010
## Time-stamp: <Last modified: 24 FEBRUARY 2010  (srdbadmin)>
##------------------------------------------------------------------------------

## retrieve science paper data
## note we get the column names from a query but the data from
## a dump of the database 
require(RODBC); require(nlme)
chan <- odbcConnect(dsn="srdbusercalo", case='postgresql',believeNRows=FALSE)
science.qu<-"select * from srdb.timeseries_values_science2009 where total is not null"
science.dat <- sqlQuery(chan,science.qu)
odbcClose(chan)
science.colnames<-names(science.dat)
science.dat<-read.csv("/home/srdbadmin/SQLpg/srdb/trunk/dump-backup/science2009.txt", as.is=TRUE,stringsAsFactors=FALSE)
names(science.dat)<-science.colnames
science.dat<-subset(science.dat,!is.na(total))

## which stocks have >= 25 years
stock.index<-c(sapply(unique(science.dat$assessid), function(x)(dim(subset(science.dat,assessid==x))[1]>=25)))
stocks.ge.25<-unique(science.dat$assessid)[stock.index]
science.dat<-subset(science.dat, tsyear>=1977 & assessid%in% stocks.ge.25)

## reshape
science.dat.wide<-reshape(science.dat,idvar=c("assessid"), direction="wide",timevar="tsyear",drop=names(science.dat)[!names(science.dat)%in%c("assessid","tsyear","total")])

total.bio<-apply(as.matrix(science.dat.wide[,-1]),2,sum,na.rm=TRUE)
years<-unique(science.dat$tsyear)
plot(years,total.bio)

## doesn't match?




##----------------
## OVERALL TRENDS
##----------------

get.unscaled.overall.index<-function(category, min.year){
  ## returns year and fixed effect estimate of log(ssb)
  if(category=="Pelagic"){
    t<-subset(dat, taxocategory==category & tsyear>=min.year)
  }
  if(category=="Demersal"){  
    t<-subset(dat, taxocategory!="Pelagic" & tsyear>=min.year)
  }
  if(category=="All"){
    t<-subset(dat, tsyear>=min.year)
  }
  if(length(t[,1])<1){return(c("No data in this region-category combination"))}else{
  assessids<-unique(t$assessid)
  ## SCALING
  ## log values
  t$logssb<-log(t$ssb)
  years<-unique(t$tsyear)[order(unique(t$tsyear))]
  ## with(t, plot(tsyear,logssb))
  ## FITS
  ## ar1 fit
      if(length(assessids)>=2){
        logssb.mixed.fit<-lme(logssb~-1+as.factor(tsyear), data=t[t$tsyear%in%years,], random=~1|assessid,  correlation = corCAR1(form = ~tsyear))
        upr<-fixef(logssb.mixed.fit)+1.96*sqrt(diag(summary(logssb.mixed.fit)$varFix))
        lwr<-fixef(logssb.mixed.fit)-1.96*sqrt(diag(summary(logssb.mixed.fit)$varFix))
        return(data.frame(years, category, n=length(assessids), index=fixef(logssb.mixed.fit), upr=upr, lwr=lwr))
      }
}}


## 1970
overall.all.unscaled.index.1970<-get.unscaled.overall.index(category="All", min.year=1970)
avg1<-mean(exp(subset(overall.all.unscaled.index.1970,years%in%c(1970:1974))$index))
avg2<-mean(exp(subset(overall.all.unscaled.index.1970,years%in%c(2005:2009))$index))
100*(1-avg2/avg1)

val.1977<-exp(subset(overall.all.unscaled.index.1970,years==1978)$index)
val.2007<-exp(subset(overall.all.unscaled.index.1970,years==2007)$index)

## 1978
overall.all.unscaled.index.1978<-get.unscaled.overall.index(category="All", min.year=1978)
avg1<-mean(exp(subset(overall.all.unscaled.index.1978,years%in%c(1978:1982))$index))
avg2<-mean(exp(subset(overall.all.unscaled.index.1978,years%in%c(2005:2009))$index))
100*(1-avg2/avg1)

